name: Weekly CVE Scan

permissions:
  contents: read

on:
  schedule:
    # Run every Friday at 9 AM UTC (4 AM EST / 5 AM EDT)
    - cron: '0 9 * * 5'
  workflow_dispatch:  # Allow manual trigger from GitHub UI
    inputs:
      release_branch:
        description: 'Release branch to scan (e.g., backplane-2.17)'
        required: false
        default: 'backplane-2.17'
        type: string
      mce_version:
        description: 'MCE version to scan (e.g., 2.17.0)'
        required: false
        type: string
      severity:
        description: 'CVE severity levels to scan'
        required: false
        default: 'HIGH,CRITICAL'
        type: string

jobs:
  cve-scan:
    name: CVE Scan - ${{ matrix.release_branch }}
    runs-on: ubuntu-latest

    # Scan multiple releases on scheduled runs, single release on manual trigger
    strategy:
      matrix:
        release_branch: ${{ github.event_name == 'schedule' && fromJSON('["backplane-2.17", "backplane-2.11", "backplane-2.10"]') || fromJSON(format('["{0}"]', inputs.release_branch || 'backplane-2.17')) }}
      fail-fast: false

    env:
      # Use matrix value for scheduled runs, or workflow input for manual runs
      RELEASE_BRANCH: ${{ matrix.release_branch }}
      ACM_VERSION: ${{ inputs.mce_version || vars.MCE_VERSION || '' }}
      TRIVY_SEVERITY: ${{ inputs.severity || vars.TRIVY_SEVERITY || 'HIGH,CRITICAL' }}

    steps:
      - name: Checkout main branch (scripts and workflow)
        uses: actions/checkout@v4
        with:
          ref: main
          path: main

      - name: Checkout release branch (image data)
        uses: actions/checkout@v4
        with:
          ref: ${{ env.RELEASE_BRANCH }}
          path: release
          sparse-checkout: |
            extras/
            icsp-config.json

      - name: Set up working directory
        run: |
          # Copy scripts, Makefile, requirements.txt from main
          cp -r main/scripts ./
          cp -r main/.github ./
          cp main/Makefile ./
          cp main/requirements.txt ./

          # Copy image data from release branch
          cp -r release/extras ./

          # Copy ICSP config if it exists in release branch
          if [ -f release/icsp-config.json ]; then
            cp release/icsp-config.json ./
          elif [ -f main/icsp-config.json ]; then
            cp main/icsp-config.json ./
          fi

          # Create reports directory
          mkdir -p reports

          echo "üìÇ Working directory setup complete"
          echo "Scripts from: main branch"
          echo "Image data from: ${{ env.RELEASE_BRANCH }}"
          ls -la extras/

      - name: Display scan configuration
        run: |
          echo "üîç CVE Scan Configuration"
          echo "========================="
          echo "Release Branch: ${{ env.RELEASE_BRANCH }}"
          echo "ACM Version: ${{ env.ACM_VERSION }}"
          echo "Severity Filter: ${{ env.TRIVY_SEVERITY }}"
          echo "Workflow Branch: ${{ github.ref_name }}"

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt

      - name: Install Trivy
        run: |
          # Install Trivy for CVE scanning
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install trivy

      - name: Install Skopeo
        run: |
          # Install skopeo for image verification
          sudo apt-get install -y skopeo

      - name: Set up container registry authentication
        run: |
          # Log in to quay.io using skopeo (matches existing workflows)
          echo "${{ secrets.QUAY_IO_ACMD_RGY_PASSWORD }}" \
            | skopeo login -u="${{ vars.QUAY_IO_ACMD_RGY_USERNAME }}" --password-stdin quay.io

          # Also login with podman for Trivy compatibility
          echo "${{ secrets.QUAY_IO_ACMD_RGY_PASSWORD }}" \
            | podman login -u="${{ vars.QUAY_IO_ACMD_RGY_USERNAME }}" --password-stdin quay.io

          # Copy auth.json to config.json for Trivy compatibility
          mkdir -p ~/.config/containers
          cp ~/.config/containers/auth.json ~/.config/containers/config.json

      - name: Verify images are accessible
        run: |
          echo "Running image verification with ICSP mirrors..."
          make verify-images-icsp || true
        continue-on-error: true

      - name: Download previous scan results for comparison
        id: download-previous
        continue-on-error: true
        run: |
          echo "Attempting to download previous CVE scan results for ${{ env.RELEASE_BRANCH }}..."

          # Get the most recent successful run (excluding current run)
          PREVIOUS_RUN=$(gh run list \
            --workflow weekly-cve-scan.yml \
            --status success \
            --limit 10 \
            --json databaseId,conclusion \
            --jq ".[0].databaseId" 2>/dev/null || echo "")

          if [ -n "$PREVIOUS_RUN" ]; then
            echo "Found previous run: $PREVIOUS_RUN"

            # Download the artifact from previous run for this release branch
            mkdir -p previous-reports

            # Look for artifact matching this release branch
            ARTIFACT_NAME=$(gh api \
              "repos/${{ github.repository }}/actions/runs/$PREVIOUS_RUN/artifacts" \
              --jq '.artifacts[] | select(.name | contains("${{ env.RELEASE_BRANCH }}")) | .name' \
              | head -1 || echo "")

            if [ -n "$ARTIFACT_NAME" ]; then
              echo "Downloading artifact: $ARTIFACT_NAME"
              gh run download "$PREVIOUS_RUN" \
                --name "$ARTIFACT_NAME" \
                --dir previous-reports 2>/dev/null || echo "Failed to download artifact"

              if [ -d "previous-reports" ] && [ "$(ls -A previous-reports)" ]; then
                echo "‚úì Previous scan results downloaded"
                echo "has_previous=true" >> $GITHUB_OUTPUT
              else
                echo "No previous scan data found"
                echo "has_previous=false" >> $GITHUB_OUTPUT
              fi
            else
              echo "No artifacts found for ${{ env.RELEASE_BRANCH }} in previous run"
              echo "has_previous=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "No previous successful runs found"
            echo "has_previous=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Run CVE scan with JSON output
        run: |
          echo "Scanning ACM ${{ env.ACM_VERSION }} images for CVEs (${{ env.TRIVY_SEVERITY }} severity)..."
          make scan-cves-json-icsp
        env:
          ACM_VERSION: ${{ env.ACM_VERSION }}
          ICSP_CONFIG: icsp-config.json
          EXTRAS_DIR: extras
          REPORTS_DIR: reports

      - name: Send summary to Slack
        if: always()
        run: |
          echo "Sending CVE report to Slack..."
          # Use bot token if available (threaded mode), otherwise webhook
          if [ -n "${{ secrets.SLACK_BOT_OAUTH_TOKEN }}" ]; then
            echo "Using threaded mode with bot token"
          else
            echo "Using webhook mode"
          fi

          # Set previous reports directory if available
          if [ "${{ steps.download-previous.outputs.has_previous }}" = "true" ]; then
            echo "Previous scan results available for comparison"
            export PREVIOUS_REPORTS_DIR="previous-reports"
          fi

          make slack-cve-report
        env:
          ACM_VERSION: ${{ env.ACM_VERSION }}
          REPORTS_DIR: reports
          EXTRAS_DIR: extras
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_CVE_WEBHOOK_URL }}
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_OAUTH_TOKEN }}
          SLACK_CHANNEL: ${{ secrets.SLACK_CVE_CHANNEL }}

      - name: Upload CVE reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cve-reports-${{ env.RELEASE_BRANCH }}-run-${{ github.run_number }}
          path: reports/
          retention-days: 90

      - name: Check for critical CVEs
        run: |
          # Count critical CVEs and fail if threshold exceeded
          CRITICAL_COUNT=$(grep -r "CRITICAL" reports/ | wc -l || echo 0)
          echo "Found $CRITICAL_COUNT CRITICAL CVE occurrences"

          if [ "$CRITICAL_COUNT" -gt 50 ]; then
            echo "‚ö†Ô∏è  Warning: Found $CRITICAL_COUNT CRITICAL CVEs (threshold: 50)"
            echo "Review the reports in the artifacts section"
          fi
        continue-on-error: true
